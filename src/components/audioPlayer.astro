---
import DownloadIcon from "./icons/downloadIcon.astro";
import PlayIcon from "./icons/playIcon.astro";
import PauseIcon from "./icons/pauseIcon.astro";
import AudioIcon from "./icons/audioIcon.astro";
import AudioMutedIcon from "./icons/audioMutedIcon.astro";
---

<div
  id="audio-player-container"
  class="fixed bottom-0 left-0 z-50 flex h-16 w-full items-center bg-base-100 px-5 opacity-0 transition-opacity duration-500 hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]"
>
  <audio src="" preload="metadata"></audio>

  <span
    id="audio-loading"
    class="loading loading-spinner loading-md min-w-[1.5rem] hidden"></span>

  <button
    id="audio-control"
    class="btn btn-ghost btn-circle hidden"
    aria-label="Play/Pause"
  >
    <span id="play-icon"><PlayIcon /></span>
    <span id="pause-icon" class="hidden"><PauseIcon /></span>
  </button>

  <div class="flex items-center ml-5 mr-2 text-sm font-mono">
    <span id="current-time">0:00</span>
    <span class="mx-1">/</span>
    <span id="duration">0:00</span>
  </div>

  <input
    id="seek-slider"
    type="range"
    min="0"
    max="0"
    value="0"
    class="range range-xs mx-5 flex-grow"
  />

  <button
    id="mute-btn"
    class="btn btn-ghost btn-circle ml-5"
    aria-label="Mute/Unmute"
  >
    <span id="audio-icon"><AudioIcon /></span>
    <span id="muted-icon" class="hidden"><AudioMutedIcon /></span>
  </button>

  <a
    href="#"
    download
    id="audio-download-link"
    class="btn btn-ghost btn-circle ml-2"
    aria-label="Download"
  >
    <DownloadIcon />
  </a>
</div>

<script>
  const audioControl = document.getElementById(
    "audio-control",
  ) as HTMLButtonElement;
  const playIcon = document.getElementById("play-icon");
  const pauseIcon = document.getElementById("pause-icon");

  const muteBtn = document.getElementById("mute-btn") as HTMLButtonElement;
  const audioIcon = document.getElementById("audio-icon");
  const mutedIcon = document.getElementById("muted-icon");

  const audioLoading = document.getElementById("audio-loading");
  const audioDownloadLink = document.getElementById(
    "audio-download-link",
  ) as HTMLAnchorElement;
  const musicPlayer = document.getElementById("audio-player-container");
  const footer = document.querySelector(".footer > div");

  const audio = document.querySelector("audio") as HTMLAudioElement;
  const durationContainer = document.getElementById("duration");
  const currentTimeContainer = document.getElementById("current-time");
  const seekSlider = document.getElementById("seek-slider") as HTMLInputElement;

  const calculateTime = (secs: number) => {
    const hours = Math.floor(secs / 3600);
    const minutes = Math.floor((secs % 3600) / 60);
    const seconds = Math.floor(secs % 60);
    const formattedMinutes = minutes < 10 ? `0${minutes}` : minutes;
    const formattedseconds = seconds < 10 ? `0${seconds}` : seconds;

    return hours > 0
      ? `${hours}:${formattedMinutes}:${formattedseconds}`
      : `${minutes}:${formattedseconds}`;
  };

  const displayDuration = () => {
    if (durationContainer && audio) {
      durationContainer.textContent = calculateTime(audio.duration);
    }
  };

  const updatePlayPauseUI = () => {
    if (!audio.paused) {
      playIcon?.classList.add("hidden");
      pauseIcon?.classList.remove("hidden");
    } else {
      playIcon?.classList.remove("hidden");
      pauseIcon?.classList.add("hidden");
    }
  };

  const togglePlayPause = () => {
    if (audio.paused) {
      audio.play();
    } else {
      audio.pause();
    }
    updatePlayPauseUI();
  };

  const updateMuteUI = () => {
    if (audio.muted) {
      audioIcon?.classList.add("hidden");
      mutedIcon?.classList.remove("hidden");
    } else {
      audioIcon?.classList.remove("hidden");
      mutedIcon?.classList.add("hidden");
    }
  };

  const toggleMute = () => {
    audio.muted = !audio.muted;
    updateMuteUI();
  };

  if (audio) {
    audio.addEventListener("loadedmetadata", () => {
      displayDuration();
      seekSlider?.setAttribute("max", audio.duration.toString());
      audioLoading?.classList.add("hidden");
      audioControl?.classList.remove("hidden");
    });

    audio.addEventListener("timeupdate", () => {
      if (seekSlider)
        seekSlider.value = Math.floor(audio.currentTime).toString();
      if (currentTimeContainer)
        currentTimeContainer.textContent = calculateTime(
          Number(seekSlider.value),
        );
    });

    audio.addEventListener("play", updatePlayPauseUI);
    audio.addEventListener("pause", updatePlayPauseUI);
  }

  audioControl?.addEventListener("click", togglePlayPause);
  muteBtn?.addEventListener("click", toggleMute);

  seekSlider?.addEventListener("input", () => {
    if (currentTimeContainer) {
      currentTimeContainer.textContent = calculateTime(
        Number(seekSlider.value),
      );
    }
  });

  seekSlider?.addEventListener("change", () => {
    if (audio) audio.currentTime = Number(seekSlider.value);
  });

  const playButtons = document.querySelectorAll(".card-pay-buttons");

  playButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const button = btn as HTMLElement;
      const audioUrl = button.dataset.audioUrl;
      if (audio && audioUrl) {
        if (!audio.src.includes(audioUrl)) {
          musicPlayer?.classList.remove("hidden");
          musicPlayer?.classList.add("flex");
          footer?.classList.add("pb-24");
          setTimeout(() => musicPlayer?.classList.remove("opacity-0"), 100);

          audioLoading?.classList.remove("hidden");
          audioControl?.classList.add("hidden");

          if (durationContainer) durationContainer.textContent = "0:00";
          if (currentTimeContainer) currentTimeContainer.textContent = "0:00";

          audio.src = audioUrl;
          if (audioDownloadLink) audioDownloadLink.href = audioUrl;

          disableOthersPlayButtons(button.id, playButtons);

          // Reset UI state for new track
          playIcon?.classList.add("hidden");
          pauseIcon?.classList.remove("hidden");

          audio.play();
        } else {
          togglePlayPause();
        }
      }
    });
  });

  function disableOthersPlayButtons(
    id: string,
    playButtons: NodeListOf<Element>,
  ) {
    playButtons.forEach((btn) => {
      const button = btn as HTMLInputElement;
      if (button.id != id) {
        button.checked = false;
      }
    });
  }
</script>
